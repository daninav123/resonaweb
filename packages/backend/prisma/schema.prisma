// This is your Prisma schema file
// Learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============= ENUMS =============

enum UserRole {
  CLIENT
  ADMIN
  SUPERADMIN
  COMMERCIAL  // Comercial con acceso a presupuestos, leads y comisiones
}

enum QuoteStatus {
  PENDING
  CONTACTED
  QUOTED
  CONVERTED
  REJECTED
}

enum CommissionStatus {
  PENDING   // Presupuesto enviado, esperando respuesta
  GENERATED // Presupuesto convertido en pedido
  PAID      // Comisi√≥n pagada al comercial
  LOST      // Presupuesto perdido/rechazado
}

enum LeadStatus {
  NEW
  CONTACTED
  INTERESTED
  NEGOTIATING
  CONVERTED  // Convertido a cliente
  LOST       // Perdido
}

enum UserLevel {
  STANDARD
  VIP
  VIP_PLUS
}

enum OrderStatus {
  PENDING // Pendiente - Reci√©n creado, esperando confirmaci√≥n de pago
  IN_PROGRESS // En Proceso - Pago confirmado, preparando pedido
  COMPLETED // Completado - Pedido entregado/recogido y finalizado
  CANCELLED // Cancelado - Pedido cancelado por el usuario o admin
}

enum DeliveryType {
  PICKUP
  DELIVERY
  SHIPPING
}

enum PaymentTerm {
  FULL_UPFRONT
  PARTIAL_UPFRONT
  ON_PICKUP
  THREE_INSTALLMENTS // 25% + 50% + 25% para eventos de calculadora
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  SUCCEEDED
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
  CANCELLED
}

enum RefundStatus {
  NONE
  PARTIAL
  FULL
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum ModificationType {
  ADD_ITEMS
  REMOVE_ITEMS
  MODIFY_ITEMS
  CHANGE_DATES
  CANCEL
}

enum DepositStatus {
  PENDING
  AUTHORIZED
  CAPTURED
  RELEASED
  PARTIALLY_RETAINED
}

enum InvoiceStatus {
  DRAFT
  PENDING
  SENT
  PAID
  OVERDUE
  CANCELLED
}

enum PaymentMethod {
  CARD
  STRIPE
  BANK_TRANSFER
  CASH
  FINANCING
  OTHER
}

enum ProductStatus {
  AVAILABLE
  OUT_OF_STOCK
  DISCONTINUED
  COMING_SOON
}

enum StockStatus {
  IN_STOCK
  ON_DEMAND
  DISCONTINUED
  SEASONAL
}

enum InteractionType {
  VIEW
  ADD_TO_CART
  REMOVE_FROM_CART
  QUOTE_REQUEST
  AVAILABILITY_CHECK
  ORDER_PLACED
  WISHLIST_ADD
  PURCHASE
}

enum DistanceZone {
  LOCAL // 0-10km
  REGIONAL // 10-30km
  EXTENDED // 30-50km
  CUSTOM // 50+ km
}

enum NotificationType {
  ORDER_CONFIRMATION
  ORDER_PAYMENT_RECEIVED
  ORDER_PAYMENT_PENDING
  ORDER_PAYMENT_FAILED
  ORDER_STATUS_UPDATE
  ORDER_CANCELLED
  REMINDER_PAYMENT_DUE
  REMINDER_3_DAYS_BEFORE
  REMINDER_1_DAY_BEFORE
  REMINDER_DAY_OF_EVENT
  REMINDER_RETURN_DUE
  RETURN_CONFIRMATION
  REVIEW_REQUEST
  DEPOSIT_RELEASED
  DEPOSIT_RETAINED
  WELCOME_EMAIL
  ABANDONED_CART
  SPECIAL_OFFER
  NEW_ORDER_ADMIN
  HIGH_DEMAND_ALERT
  LOW_STOCK_ALERT
}

enum EmailStatus {
  PENDING
  QUEUED
  SENDING
  SENT
  DELIVERED
  OPENED
  CLICKED
  FAILED
  BOUNCED
}

enum InstallationComplexity {
  NONE           // No requiere instalaci√≥n especial
  FORCE_SIMPLE   // Fuerza montaje simple (productos muy b√°sicos)
  FORCE_COMPLEX  // Fuerza montaje complejo (guirnaldas, estructuras grandes, etc.)
}

enum PriceType {
  FIXED
  PER_HOUR
  PER_ITEM
  PER_AREA
  CUSTOM
}

enum PackCategory {
  BODAS
  EVENTOS_PRIVADOS
  CONCIERTOS
  EVENTOS_CORPORATIVOS
  CONFERENCIAS
  MONTAJE
  EXTRAS
  OTROS
}

// ============= MODELS =============

model User {
  id        String    @id @default(uuid())
  email     String    @unique
  password  String
  firstName String
  lastName  String
  phone     String?
  role      UserRole  @default(CLIENT)
  userLevel UserLevel @default(STANDARD)

  // Direcci√≥n
  address Json?

  // Estado
  isActive      Boolean @default(true)
  emailVerified Boolean @default(false)

  // Legal y RGPD
  acceptedTermsAt   DateTime?
  acceptedPrivacyAt DateTime?
  termsVersion      String?
  
  // RGPD: Consentimientos
  acceptedMarketingAt DateTime? // Fecha de consentimiento para comunicaciones comerciales
  marketingConsent    Boolean   @default(false) // Acepta recibir marketing
  dataProcessingConsent Boolean @default(true) // Consentimiento general para tratamiento de datos
  lastConsentUpdate   DateTime? // √öltima actualizaci√≥n de consentimientos

  // Fechas
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastLoginAt DateTime?

  // Password reset
  resetToken       String?   @db.Text
  resetTokenExpiry DateTime?

  // Relaciones
  orders             Order[]
  reviews            Review[]
  favorites          Favorite[]
  emailNotifications EmailNotification[]
  notifications      Notification[]
  apiKeys            ApiKey[]
  customerNotes      CustomerNote[]      @relation("CustomerNotes")
  notesCreated       CustomerNote[]      @relation("NotesCreatedBy")
  blogPosts          BlogPost[]
  orderNotes         OrderNote[]
  coupons            Coupon[]
  couponUsages       CouponUsage[]
  userDiscount       UserDiscount?
  billingData        BillingData?
  orderModifications OrderModification[]
  carts              Cart[]
  budgets            Budget[] // Presupuestos creados
  commissions        Commission[] // Comisiones del comercial
  leads              Lead[] // Leads gestionados
  quoteRequests      QuoteRequest[] // Solicitudes de presupuesto asignadas

  // Stripe
  stripeCustomerId String?
  taxId            String?

  // Metadata
  metadata Json?

  @@index([email])
  @@index([role])
  @@index([stripeCustomerId])
}

model BillingData {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Datos fiscales
  companyName String? // Raz√≥n social (opcional para particulares)
  taxId       String // NIF/CIF/DNI (obligatorio)
  taxIdType   String  @default("NIF") // NIF, CIF, NIE, PASSPORT

  // Direcci√≥n fiscal
  address      String
  addressLine2 String? // Piso, puerta, etc.
  city         String
  state        String // Provincia
  postalCode   String
  country      String  @default("Espa√±a")

  // Contacto
  phone String?
  email String? // Email de facturaci√≥n (puede ser diferente al de la cuenta)

  // Preferencias
  isDefault Boolean @default(true)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([taxId])
}

model Category {
  id          String     @id @default(uuid())
  name        String
  slug        String     @unique
  description String?
  imageUrl    String?
  parentId    String?
  parent      Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryHierarchy")

  isActive  Boolean @default(true)
  featured  Boolean @default(false)
  isHidden  Boolean @default(false) // Categor√≠a oculta (solo admin)
  sortOrder Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  products Product[]
  coupons  Coupon[]
  packs    Pack[]

  @@index([slug])
  @@index([parentId])
}

model Product {
  id          String  @id @default(uuid())
  sku         String  @unique
  name        String
  slug        String  @unique
  description String? @db.Text

  // Categor√≠a (opcional para packs)
  categoryId String?
  category   Category? @relation(fields: [categoryId], references: [id])

  // Categor√≠a de Extra (para organizarlos en la calculadora)
  extraCategoryId String?
  extraCategory   ExtraCategory? @relation("ExtraCategoryProducts", fields: [extraCategoryId], references: [id])

  // Precios
  pricePerDay       Decimal @db.Decimal(10, 2)
  pricePerWeekend   Decimal @db.Decimal(10, 2)
  pricePerWeek      Decimal @db.Decimal(10, 2)
  weekendMultiplier Decimal @default(1.5) @db.Decimal(3, 2)
  weekMultiplier    Decimal @default(5.0) @db.Decimal(3, 2)

  // Stock
  stock          Int           @default(0)
  realStock      Int           @default(0)
  availableStock Int           @default(0)
  status         ProductStatus @default(AVAILABLE)
  stockStatus    StockStatus   @default(IN_STOCK)
  leadTimeDays   Int           @default(30)
  canBuyOnDemand Boolean       @default(true)

  // Dimensiones y peso
  weight                   Decimal? @db.Decimal(8, 2)
  length                   Decimal? @db.Decimal(8, 2)
  width                    Decimal? @db.Decimal(8, 2)
  height                   Decimal? @db.Decimal(8, 2)
  volume                   Decimal? @db.Decimal(10, 2)
  dimensions               Json?
  requiresSpecialTransport Boolean  @default(false)

  // NOTA: Env√≠o y montaje se gestionan mediante Packs de categor√≠a MONTAJE

  // Fianza
  purchaseValue   Decimal? @db.Decimal(10, 2)
  replacementCost Decimal? @db.Decimal(10, 2)
  customDeposit   Decimal? @db.Decimal(10, 2)

  // Im√°genes
  mainImageUrl String?
  images       String[]

  // Especificaciones
  specifications Json?

  // Tracking
  viewCount         Int     @default(0)
  cartAddCount      Int     @default(0)
  quoteRequestCount Int     @default(0)
  orderCount        Int     @default(0)
  purchasePriority  Int?
  markedForPurchase Boolean @default(false)
  purchaseNotes     String?

  // Proveedor
  supplier      String?
  supplierPrice Decimal? @db.Decimal(10, 2)
  supplierUrl   String?

  // Estad√≠sticas de compra y uso (solo admin)
  purchasePrice Decimal?  @db.Decimal(10, 2)
  purchaseDate  DateTime?
  timesUsed     Int       @default(0)

  // Estado
  isActive            Boolean @default(true)
  featured            Boolean @default(false)
  maintenanceRequired Boolean @default(false)

  // Pack
  isPack Boolean @default(false)

  // Consumible (productos que se venden, no se alquilan)
  isConsumable Boolean  @default(false)
  pricePerUnit Decimal? @db.Decimal(10, 2) // Precio por unidad para consumibles

  // Complejidad de instalaci√≥n (para c√°lculo de montaje en presupuestos)
  installationComplexity InstallationComplexity @default(NONE)

  // Metadatos
  tags String[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  orderItems   OrderItem[]
  packItems    PackItem[]
  reviews      Review[]
  favorites    Favorite[]
  interactions ProductInteraction[]
  analytics    ProductDemandAnalytics?
  productSpecs ProductSpecification?
  coupons      Coupon[]
  cartItems    CartItem[]
  budgetItems  BudgetItem[] // Items en presupuestos

  // Relaciones de Pack (cuando este producto ES un pack)
  components  ProductComponent[] @relation("PackComponents")
  // Relaciones cuando este producto ES componente de un pack
  usedInPacks ProductComponent[] @relation("ComponentInPacks")

  // Historial de compras (lotes)
  purchases ProductPurchase[]

  @@index([categoryId])
  @@index([extraCategoryId])
  @@index([slug])
  @@index([stockStatus])
  @@index([isActive, featured])
  @@index([isPack])
  @@index([isConsumable])
}

// Componentes de un pack (qu√© productos incluye cada pack)
model ProductComponent {
  id String @id @default(uuid())

  // El pack (producto que ES un pack)
  packId String
  pack   Product @relation("PackComponents", fields: [packId], references: [id], onDelete: Cascade)

  // El componente (producto que est√° DENTRO del pack)
  componentId String
  component   Product @relation("ComponentInPacks", fields: [componentId], references: [id], onDelete: Cascade)

  // Cantidad de este componente en el pack
  quantity Int @default(1)

  createdAt DateTime @default(now())

  @@unique([packId, componentId])
  @@index([packId])
  @@index([componentId])
}

// Historial de compras de productos (lotes)
model ProductPurchase {
  id String @id @default(uuid())

  // Producto al que pertenece este lote
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  // Informaci√≥n de la compra
  purchaseDate DateTime @default(now())
  quantity     Int      @default(1) // Cu√°ntas unidades se compraron en este lote
  unitPrice    Decimal  @db.Decimal(10, 2) // Precio por unidad en esta compra
  totalCost    Decimal  @db.Decimal(10, 2) // quantity √ó unitPrice

  // Informaci√≥n adicional
  supplier      String? // Nombre del proveedor
  invoiceNumber String? // N√∫mero de factura
  notes         String? @db.Text // Notas adicionales

  // Amortizaci√≥n del lote
  totalGenerated Decimal @default(0) @db.Decimal(10, 2) // Total generado por este lote
  isAmortized    Boolean @default(false) // Si ya se amortiz√≥ completamente

  // Auditor√≠a
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([productId])
  @@index([purchaseDate])
  @@index([isAmortized])
}

model Pack {
  id          String  @id @default(uuid())
  name        String
  slug        String  @unique
  description String  @db.Text
  imageUrl    String?

  // C√°lculo autom√°tico de precios (suma de todos los componentes)
  basePricePerDay      Decimal @default(0) @db.Decimal(10, 2) // Suma de pricePerDay de productos
  calculatedTotalPrice Decimal @default(0) @db.Decimal(10, 2) // basePricePerDay

  // Descuento del pack
  discountPercentage Decimal @default(0) @db.Decimal(5, 2) // Descuento en porcentaje (0-100)
  discountAmount     Decimal @default(0) @db.Decimal(10, 2) // Cantidad de descuento calculada

  // Precio final (editable por admin)
  finalPrice         Decimal @db.Decimal(10, 2) // Precio final que paga el cliente
  customPriceEnabled Boolean @default(false) // Si el admin estableci√≥ un precio personalizado

  // Ahorro para el cliente
  savingsAmount     Decimal @default(0) @db.Decimal(10, 2) // calculatedTotalPrice - finalPrice
  savingsPercentage Decimal @default(0) @db.Decimal(5, 2) // (savingsAmount / calculatedTotalPrice) * 100

  // Configuraci√≥n
  autoCalculate Boolean @default(true) // Si calcula autom√°ticamente los precios

  // Precio variable por partes del evento
  partsPricing       Json? // { "partId": { "price": 150, "included": true } }
  enablePartsPricing Boolean  @default(false) // Si el precio var√≠a seg√∫n partes seleccionadas
  basePrice          Decimal? @db.Decimal(10, 2) // Precio base del pack (antes de sumar partes)

  // Categor√≠a del pack
  category    PackCategory @default(OTROS) // Categor√≠a del pack (enum legacy, mantener para compatibilidad)
  categoryId  String? // ID de la categor√≠a del producto
  categoryRef Category?    @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  // Coste de transporte (para montajes)
  transportCost Decimal @default(0) @db.Decimal(10, 2) // Coste del transporte e instalaci√≥n

  isActive Boolean @default(true)
  featured Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  items PackItem[]

  @@index([slug])
}

model PackItem {
  id        String  @id @default(uuid())
  packId    String
  pack      Pack    @relation(fields: [packId], references: [id], onDelete: Cascade)
  productId String
  product   Product @relation(fields: [productId], references: [id])

  quantity Int @default(1)

  // Campos espec√≠ficos para personal (montadores, DJs, t√©cnicos, etc.)
  numberOfPeople Int? // N√∫mero de personas (ej: 2 montadores)
  hoursPerPerson Decimal? @db.Decimal(8, 2) // Horas por persona (ej: 3 horas)

  // Contabilidad
  estimatedCost Decimal? @db.Decimal(10, 2) // Coste estimado inicial
  realCost      Decimal? @db.Decimal(10, 2) // Coste real final

  @@unique([packId, productId])
}

model Order {
  id          String @id @default(uuid())
  orderNumber String @unique

  // Cliente
  userId String
  user   User   @relation(fields: [userId], references: [id])

  // Fechas del evento
  startDate DateTime
  endDate   DateTime

  // Informaci√≥n del evento
  eventType     String?
  eventLocation Json // Direcci√≥n completa
  attendees     Int?
  contactPerson String
  contactPhone  String
  notes         String? @db.Text

  // Entrega
  deliveryType    DeliveryType
  deliveryAddress Json?
  deliveryTime    String?
  deliveryNotes   String?

  // Modalidad de pago
  paymentTerm           PaymentTerm @default(PARTIAL_UPFRONT)
  paymentTermAdjustment Decimal     @default(0) @db.Decimal(10, 2)
  paymentTermPercent    Decimal     @default(0) @db.Decimal(5, 2)

  // Totales
  subtotal              Decimal  @db.Decimal(10, 2)
  totalBeforeAdjustment Decimal  @db.Decimal(10, 2)
  paymentTermDiscount   Decimal? @db.Decimal(10, 2)
  paymentTermSurcharge  Decimal? @db.Decimal(10, 2)
  taxAmount             Decimal  @db.Decimal(10, 2)
  total                 Decimal  @db.Decimal(10, 2)
  realCost              Decimal  @default(0) @db.Decimal(10, 2) // Gastos reales del pedido (contabilidad)

  // Pagos
  upfrontPaymentAmount   Decimal?       @db.Decimal(10, 2)
  upfrontPaymentDate     DateTime?
  upfrontPaymentStatus   PaymentStatus?
  remainingPaymentAmount Decimal?       @db.Decimal(10, 2)
  remainingPaymentDue    DateTime?
  remainingPaymentDate   DateTime?
  remainingPaymentStatus PaymentStatus?

  // Env√≠o
  shippingCost        Decimal  @db.Decimal(10, 2)
  shippingSuggested   Decimal? @db.Decimal(10, 2)
  shippingManuallySet Boolean  @default(false)
  shippingNotes       String?
  shippingDistance    Decimal? @db.Decimal(10, 2)
  shippingWeight      Decimal? @db.Decimal(10, 2)
  shippingVolume      Decimal? @db.Decimal(10, 2)

  // Fianza
  depositAmount         Decimal       @db.Decimal(10, 2)
  depositStatus         DepositStatus @default(PENDING)
  depositPaidAt         DateTime?
  depositReleasedAt     DateTime?
  depositRetainedAmount Decimal?      @db.Decimal(10, 2)
  depositNotes          String?

  // Estado
  status          OrderStatus @default(PENDING)
  reviewRequested Boolean     @default(false)

  // Devoluci√≥n
  returnedAt      DateTime?
  returnNotes     String?   @db.Text
  returnCondition String? // PERFECT, GOOD, DAMAGED

  // Stripe Payment
  stripePaymentIntentId String?   @unique
  stripeCustomerId      String?
  paidAt                DateTime?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  confirmedAt DateTime?
  cancelledAt DateTime?
  completedAt DateTime?

  // Relaciones
  items              OrderItem[]
  services           OrderService[]
  invoice            Invoice?
  emailNotifications EmailNotification[]
  delivery           Delivery?
  payment            Payment?
  orderNotes         OrderNote[]
  couponUsages       CouponUsage[]
  modifications      OrderModification[]

  // Descuentos aplicados
  couponCode         String?
  discountAmount     Decimal  @default(0) @db.Decimal(10, 2)
  discountPercentage Decimal? @db.Decimal(5, 2)

  // Modificaciones y reembolsos
  isModified        Boolean      @default(false)
  originalTotal     Decimal?     @db.Decimal(10, 2)
  modificationCount Int          @default(0)
  lastModifiedAt    DateTime?
  cancelReason      String?
  refundAmount      Decimal?     @db.Decimal(10, 2)
  refundStatus      RefundStatus @default(NONE)
  refundProcessedAt DateTime?

  // Campos adicionales para compatibilidad
  totalAmount   Decimal       @default(0) @db.Decimal(10, 2)
  deliveryFee   Decimal       @default(0) @db.Decimal(10, 2)
  tax           Decimal       @default(0) @db.Decimal(10, 2)
  deliveryDate  DateTime?
  deliveredAt   DateTime?
  paymentStatus PaymentStatus @default(PENDING)

  // Pagos en plazos (solo para eventos de calculadora > 500‚Ç¨)
  installments            PaymentInstallment[]
  eligibleForInstallments Boolean              @default(false)
  isCalculatorEvent       Boolean              @default(false)

  // Presupuesto relacionado (si se convirti√≥ de presupuesto)
  budget Budget?

  @@index([userId])
  @@index([status])
  @@index([startDate, endDate])
  @@index([orderNumber])
  @@index([paymentStatus])
}

model OrderNote {
  id      String @id @default(uuid())
  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)
  userId  String
  user    User   @relation(fields: [userId], references: [id])

  content     String  @db.Text
  isInternal  Boolean @default(false) // true = solo admin, false = visible para cliente
  attachments Json? // URLs de archivos adjuntos si los hay

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orderId])
  @@index([userId])
  @@index([createdAt])
}

model OrderItem {
  id        String  @id @default(uuid())
  orderId   String
  order     Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId String
  product   Product @relation(fields: [productId], references: [id])

  quantity    Int
  pricePerDay Decimal @db.Decimal(10, 2)
  subtotal    Decimal @db.Decimal(10, 2)

  // Fechas del item (heredadas del pedido normalmente)
  startDate DateTime
  endDate   DateTime

  // Aliases para compatibilidad
  pricePerUnit Decimal @default(0) @db.Decimal(10, 2)
  totalPrice   Decimal @default(0) @db.Decimal(10, 2)

  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orderId])
  @@index([productId])
  @@index([startDate, endDate])
}

model ShippingRate {
  id   String @id @default(uuid())
  name String

  basePrice  Decimal @db.Decimal(10, 2)
  pricePerKm Decimal @db.Decimal(10, 2)
  pricePerKg Decimal @db.Decimal(10, 2)
  pricePerM3 Decimal @db.Decimal(10, 2)

  minPrice  Decimal  @db.Decimal(10, 2)
  maxPrice  Decimal? @db.Decimal(10, 2)
  freeAbove Decimal? @db.Decimal(10, 2)

  isActive  Boolean @default(true)
  isDefault Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Service {
  id          String  @id @default(uuid())
  name        String
  description String?

  priceType      PriceType
  price          Decimal   @db.Decimal(10, 2)
  estimatedHours Decimal?  @db.Decimal(5, 2)
  pricePerItem   Decimal?  @db.Decimal(10, 2)

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  orderServices OrderService[]
}

model OrderService {
  id        String  @id @default(uuid())
  orderId   String
  order     Order   @relation(fields: [orderId], references: [id])
  serviceId String
  service   Service @relation(fields: [serviceId], references: [id])

  quantity       Int      @default(1)
  price          Decimal  @db.Decimal(10, 2)
  suggestedPrice Decimal? @db.Decimal(10, 2)
  manuallySet    Boolean  @default(false)
  notes          String?

  createdAt DateTime @default(now())

  @@index([orderId])
}

model CustomInvoice {
  id            String @id @default(uuid())
  invoiceNumber String @unique

  clientName    String
  clientEmail   String
  clientPhone   String?
  clientNIF     String?
  clientAddress Json

  serviceDate DateTime
  items       Json[]

  subtotal  Decimal @db.Decimal(10, 2)
  taxRate   Decimal @default(21) @db.Decimal(5, 2)
  taxAmount Decimal @db.Decimal(10, 2)
  total     Decimal @db.Decimal(10, 2)

  status InvoiceStatus @default(DRAFT)
  notes  String?
  pdfUrl String?

  issueDate DateTime  @default(now())
  dueDate   DateTime?
  paidDate  DateTime?
  sentDate  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Invoice {
  id            String  @id @default(uuid())
  invoiceNumber String  @unique
  orderId       String? @unique
  order         Order?  @relation(fields: [orderId], references: [id])

  issueDate DateTime @default(now())
  dueDate   DateTime

  subtotal  Decimal @db.Decimal(10, 2)
  taxAmount Decimal @db.Decimal(10, 2)
  total     Decimal @db.Decimal(10, 2)

  status InvoiceStatus @default(DRAFT)

  pdfUrl String?
  sentAt DateTime?
  paidAt DateTime?

  // Facturae (XML electr√≥nico espa√±ol)
  facturaeXml       String? @db.Text // Contenido XML Facturae
  facturaeUrl       String? // URL del archivo XML
  facturaeSeries    String? @default("A") // Serie de factura
  facturaeGenerated Boolean @default(false)

  // Additional fields for compatibility
  metadata Json?
  tax      Decimal @default(0) @db.Decimal(10, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  payments Payment[]
}

model Payment {
  id        String   @id @default(uuid())
  invoiceId String?
  invoice   Invoice? @relation(fields: [invoiceId], references: [id])
  orderId   String?  @unique
  order     Order?   @relation(fields: [orderId], references: [id])

  amount   Decimal @db.Decimal(10, 2)
  currency String  @default("EUR")

  // Stripe Integration
  stripePaymentIntentId String? @unique
  stripeChargeId        String?
  stripeCustomerId      String?
  stripePaymentMethodId String?

  method PaymentMethod
  status PaymentStatus @default(PENDING)

  // Detalles de tarjeta
  cardBrand    String?
  cardLast4    String?
  cardExpMonth Int?
  cardExpYear  Int?

  // Referencia para otros m√©todos
  reference String?

  // Metadata
  metadata     Json?
  errorMessage String?
  notes        String?

  // Refunds
  refundedAmount Decimal?  @db.Decimal(10, 2)
  refundedAt     DateTime?
  failedAt       DateTime?

  paidAt    DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([orderId])
  @@index([invoiceId])
}

model PaymentInstallment {
  id      String @id @default(uuid())
  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  installmentNumber Int // 1, 2, 3
  percentage        Decimal       @db.Decimal(5, 2) // 25.00, 50.00, 25.00
  amount            Decimal       @db.Decimal(10, 2)
  dueDate           DateTime
  paidDate          DateTime?
  status            PaymentStatus @default(PENDING)

  // Stripe Integration
  stripePaymentIntentId String? @unique
  stripeChargeId        String?
  paymentMethod         String? // "card", "transfer", etc.

  // Metadata
  notes        String?
  errorMessage String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orderId])
  @@index([status])
  @@index([dueDate])
  @@index([installmentNumber])
}

model Review {
  id        String  @id @default(uuid())
  userId    String
  user      User    @relation(fields: [userId], references: [id])
  productId String
  product   Product @relation(fields: [productId], references: [id])

  rating  Int // 1-5
  title   String?
  comment String? @db.Text

  isApproved Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, productId])
  @@index([productId])
}

model Favorite {
  id        String  @id @default(uuid())
  userId    String
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([userId, productId])
}

model ApiKey {
  id          String  @id @default(uuid())
  name        String
  description String?
  key         String  @unique
  secret      String // Hash bcrypt

  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  permissions String[]
  rateLimit   Int      @default(100)

  isActive   Boolean   @default(true)
  lastUsedAt DateTime?
  expiresAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([key])
  @@index([isActive])
}

model ProductInteraction {
  id        String  @id @default(uuid())
  productId String
  product   Product @relation(fields: [productId], references: [id])

  userId    String?
  sessionId String

  type     InteractionType
  source   String?
  referrer String?
  metadata Json?

  createdAt DateTime @default(now())

  @@index([productId, type])
  @@index([createdAt])
}

model ProductDemandAnalytics {
  id        String  @id @default(uuid())
  productId String  @unique
  product   Product @relation(fields: [productId], references: [id])

  views30d         Int @default(0)
  cartAdds30d      Int @default(0)
  quoteRequests30d Int @default(0)
  orders30d        Int @default(0)

  views90d         Int @default(0)
  cartAdds90d      Int @default(0)
  quoteRequests90d Int @default(0)
  orders90d        Int @default(0)

  viewToCartRate  Decimal @db.Decimal(5, 2)
  cartToOrderRate Decimal @db.Decimal(5, 2)

  demandScore            Decimal @db.Decimal(10, 2)
  purchaseRecommendation Boolean @default(false)

  lastCalculated DateTime @updatedAt
}

model EmailNotification {
  id String @id @default(uuid())

  userId String?
  user   User?   @relation(fields: [userId], references: [id])
  email  String

  type     NotificationType
  template String

  orderId String?
  order   Order?  @relation(fields: [orderId], references: [id])

  subject  String
  body     String @db.Text
  metadata Json?

  status       EmailStatus @default(PENDING)
  sentAt       DateTime?
  deliveredAt  DateTime?
  openedAt     DateTime?
  clickedAt    DateTime?
  failedAt     DateTime?
  errorMessage String?

  sendgridId  String? @unique
  attempts    Int     @default(0)
  maxAttempts Int     @default(3)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([orderId])
  @@index([type])
  @@index([status])
}

model AuditLog {
  id        String  @id @default(uuid())
  userId    String?
  action    String // "CREATE_ORDER", "UPDATE_PRODUCT"
  entity    String // "Order", "Product"
  entityId  String
  changes   Json? // Before/After
  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([entity, entityId])
  @@index([createdAt])
}

model SystemConfig {
  id    String @id @default(uuid())
  key   String @unique
  value Json

  updatedAt DateTime @updatedAt
}

// ============= NUEVOS MODELOS PARA COMPLETAR FUNCIONALIDAD =============

enum DeliveryStatus {
  SCHEDULED
  IN_TRANSIT
  DELIVERED
  FAILED
  RETURNED
}

model Delivery {
  id      String @id @default(uuid())
  orderId String @unique
  order   Order  @relation(fields: [orderId], references: [id])

  vehicleId String?
  driverId  String?

  plannedDate DateTime
  actualDate  DateTime?

  status    DeliveryStatus @default(SCHEDULED)
  signature String?
  notes     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orderId])
  @@index([plannedDate])
  @@index([status])
}

model CustomerNote {
  id     String @id @default(uuid())
  userId String
  user   User   @relation("CustomerNotes", fields: [userId], references: [id])

  note          String @db.Text
  createdBy     String
  createdByUser User   @relation("NotesCreatedBy", fields: [createdBy], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([createdBy])
}

model Notification {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id])

  type    String
  title   String
  message String @db.Text
  data    Json?

  read      Boolean   @default(false)
  readAt    DateTime?
  emailSent Boolean   @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([read])
  @@index([createdAt])
}

// ============= BLOG MODELS =============

enum BlogPostStatus {
  DRAFT
  SCHEDULED
  PUBLISHED
  ARCHIVED
}

model BlogPost {
  id String @id @default(cuid())

  title   String
  slug    String @unique
  excerpt String @db.Text
  content String @db.Text

  // SEO
  metaTitle       String?
  metaDescription String?
  metaKeywords    String?

  // Media
  featuredImage String?
  images        String[]

  // Organization
  categoryId String?
  category   BlogCategory? @relation(fields: [categoryId], references: [id])
  tags       BlogTag[]

  // Publishing
  status       BlogPostStatus @default(DRAFT)
  publishedAt  DateTime?
  scheduledFor DateTime?

  // Author
  authorId String
  author   User   @relation(fields: [authorId], references: [id])

  // Engagement
  views Int @default(0)
  likes Int @default(0)

  // AI Generation
  aiGenerated Boolean @default(false)
  aiPrompt    String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([status])
  @@index([publishedAt])
  @@index([categoryId])
  @@index([authorId])
}

model BlogCategory {
  id String @id @default(cuid())

  name        String  @unique
  slug        String  @unique
  description String? @db.Text
  color       String? // Color hex para UI

  posts BlogPost[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
}

model BlogTag {
  id String @id @default(cuid())

  name String @unique
  slug String @unique

  posts BlogPost[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
}

model ShippingConfig {
  id String @id @default(uuid())

  // Tarifas base por zona
  localZoneMax  Int     @default(10) // km
  localZoneRate Decimal @default(15) @db.Decimal(10, 2)

  regionalZoneMax  Int     @default(30) // km
  regionalZoneRate Decimal @default(30) @db.Decimal(10, 2)

  extendedZoneMax  Int     @default(50) // km
  extendedZoneRate Decimal @default(50) @db.Decimal(10, 2)

  customZoneRatePerKm Decimal @default(1.5) @db.Decimal(10, 2)

  // M√≠nimos
  minimumShippingCost     Decimal @default(20) @db.Decimal(10, 2)
  minimumWithInstallation Decimal @default(50) @db.Decimal(10, 2)

  // Direcci√≥n base para c√°lculo
  baseAddress   String   @default("Madrid, Espa√±a")
  baseLatitude  Decimal? @db.Decimal(10, 7)
  baseLongitude Decimal? @db.Decimal(10, 7)

  // Configuraci√≥n adicional
  freeShippingThreshold Decimal? @db.Decimal(10, 2) // Env√≠o gratis si pedido > X‚Ç¨
  urgentSurcharge       Decimal  @default(50) @db.Decimal(10, 2)
  nightSurcharge        Decimal  @default(30) @db.Decimal(10, 2)

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CompanySettings {
  id String @id @default(uuid())

  // Datos de la empresa
  companyName String  @default("ReSona Events S.L.")
  ownerName   String? // Nombre del propietario/aut√≥nomo
  taxId       String? // NIF/CIF

  // Direcci√≥n
  address    String?
  city       String?
  postalCode String?
  province   String?
  country    String  @default("Espa√±a")

  // Contacto
  phone   String?
  email   String?
  website String?

  // Logo y branding
  logoUrl      String?
  primaryColor String  @default("#5ebbff")

  // Informaci√≥n legal
  registryNumber String? // N√∫mero de registro mercantil
  bankAccount    String? // IBAN para pagos

  // Notas para facturas
  invoiceNotes    String? @db.Text
  termsConditions String? @db.Text

  // Solo puede haber una configuraci√≥n
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("company_settings")
}

// ============= SISTEMA DE CUPONES =============

enum DiscountType {
  PERCENTAGE // Porcentaje de descuento
  FIXED_AMOUNT // Cantidad fija
  FREE_SHIPPING // Env√≠o gratis
}

enum CouponScope {
  ALL_PRODUCTS // Todos los productos
  CATEGORY // Categor√≠a espec√≠fica
  PRODUCT // Producto espec√≠fico
  USER // Usuario espec√≠fico
}

model Coupon {
  id          String  @id @default(uuid())
  code        String  @unique
  description String?

  // Tipo y valor del descuento
  discountType  DiscountType @default(PERCENTAGE)
  discountValue Decimal      @db.Decimal(10, 2)

  // Alcance del cup√≥n
  scope      CouponScope @default(ALL_PRODUCTS)
  categoryId String?
  category   Category?   @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  productId  String?
  product    Product?    @relation(fields: [productId], references: [id], onDelete: SetNull)
  userId     String?
  user       User?       @relation(fields: [userId], references: [id], onDelete: SetNull)

  // L√≠mites
  minimumAmount     Decimal? @db.Decimal(10, 2) // Monto m√≠nimo de compra
  maxDiscount       Decimal? @db.Decimal(10, 2) // Descuento m√°ximo (para porcentajes)
  usageLimit        Int? // L√≠mite total de usos
  usageCount        Int      @default(0) // Veces usado
  usageLimitPerUser Int?     @default(1) // L√≠mite por usuario

  // Validez
  validFrom DateTime  @default(now())
  validTo   DateTime?
  isActive  Boolean   @default(true)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  couponUsages CouponUsage[]

  @@index([code])
  @@index([scope])
  @@index([isActive, validFrom, validTo])
}

model CouponUsage {
  id       String @id @default(uuid())
  couponId String
  coupon   Coupon @relation(fields: [couponId], references: [id], onDelete: Cascade)
  userId   String
  user     User   @relation(fields: [userId], references: [id])
  orderId  String
  order    Order  @relation(fields: [orderId], references: [id])

  discountApplied Decimal  @db.Decimal(10, 2)
  usedAt          DateTime @default(now())

  @@unique([couponId, orderId])
  @@index([userId])
  @@index([couponId])
}

model UserDiscount {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Descuento permanente para usuarios VIP
  discountType  DiscountType @default(PERCENTAGE)
  discountValue Decimal      @db.Decimal(10, 2)
  reason        String? // "VIP", "Empleado", "Partner", etc.

  validFrom DateTime  @default(now())
  validTo   DateTime?
  isActive  Boolean   @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([isActive])
}

model OrderModification {
  id      String @id @default(uuid())
  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  modifiedBy     String
  modifiedByUser User   @relation(fields: [modifiedBy], references: [id])

  type   ModificationType
  reason String?          @db.Text

  // Valores antes de la modificaci√≥n
  oldTotal Decimal @db.Decimal(10, 2)
  oldItems Json? // Array de items originales
  oldDates Json? // {startDate, endDate} originales

  // Valores despu√©s de la modificaci√≥n
  newTotal Decimal @db.Decimal(10, 2)
  newItems Json? // Array de items nuevos
  newDates Json? // {startDate, endDate} nuevas

  // Diferencia monetaria
  difference Decimal @db.Decimal(10, 2) // Positivo = cargo, Negativo = reembolso

  // Pago/Reembolso asociado a esta modificaci√≥n
  stripePaymentId String? // Payment Intent ID para cargos adicionales
  stripeRefundId  String? // Refund ID para reembolsos
  paymentStatus   PaymentStatus @default(PENDING)

  // Detalles adicionales
  itemsAdded   Json? // Items que se a√±adieron
  itemsRemoved Json? // Items que se eliminaron

  createdAt   DateTime  @default(now())
  processedAt DateTime?

  @@index([orderId])
  @@index([modifiedBy])
  @@index([type])
  @@index([createdAt])
  @@map("order_modifications")
}

model ProductSpecification {
  id        String  @id @default(uuid())
  productId String  @unique
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  // Technical specifications as JSON
  specs Json? @db.Json

  // Common specifications
  power         String? // Potencia (e.g., "1000W")
  connectivity  String? // Conectividad (e.g., "XLR, RCA")
  compatibility String? // Compatibilidad
  materials     String? // Materiales
  warranty      String? // Garant√≠a

  // Audio specifications
  frequency   String? // Respuesta de frecuencia
  sensitivity String? // Sensibilidad
  impedance   String? // Impedancia
  maxSPL      String? // SPL m√°ximo

  // Video/Light specifications
  resolution String? // Resoluci√≥n
  brightness String? // Brillo/Lumens
  colorTemp  String? // Temperatura de color
  beamAngle  String? // √Ångulo de haz

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("product_specifications")
}

model QuoteRequest {
  id String @id @default(uuid())

  // Informaci√≥n del cliente
  customerName  String?
  customerEmail String?
  customerPhone String?

  // Informaci√≥n del evento
  eventType     String
  attendees     Int
  duration      Int
  durationType  String // 'hours' | 'days'
  eventDate     String?
  eventLocation String?

  // Productos seleccionados
  selectedPack   String? // ID del pack
  selectedExtras Json // { productId: quantity }

  // C√°lculo autom√°tico
  estimatedTotal Decimal? @db.Decimal(10, 2)

  // Estado
  status     QuoteStatus @default(PENDING)
  notes      String?     @db.Text
  adminNotes String?     @db.Text

  // Sistema de pagos
  paymentToken    String?  @unique // Token √∫nico para enlace de pago
  firstPayment    Decimal? @db.Decimal(10, 2) // 25% al reservar
  secondPayment   Decimal? @db.Decimal(10, 2) // 50% un mes antes
  thirdPayment    Decimal? @db.Decimal(10, 2) // 25% d√≠a del evento
  firstPaymentPaid    Boolean @default(false)
  secondPaymentPaid   Boolean @default(false)
  thirdPaymentPaid    Boolean @default(false)
  firstPaymentDate    DateTime?
  secondPaymentDate   DateTime?
  thirdPaymentDate    DateTime?

  // Comercial asignado
  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  // Comisiones generadas
  commissions Commission[]

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([customerEmail])
  @@index([createdAt])
  @@index([paymentToken])
  @@index([userId])
  @@map("quote_requests")
}

// ============= CARRITO =============

model Cart {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Items del carrito
  items CartItem[]

  // Informaci√≥n del evento (si viene de la calculadora)
  eventType     String?
  eventDate     String?
  eventLocation String?
  attendees     Int?
  duration      Int?
  durationType  String? // 'hours' | 'days'

  // Fechas del alquiler
  startDate DateTime?
  endDate   DateTime?

  // Opciones de entrega
  deliveryOption      String? // 'pickup' | 'delivery'
  deliveryDistance    Float?
  includeInstallation Boolean @default(false)

  // Notas
  notes String? @db.Text

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([createdAt])
}

model CartItem {
  id     String @id @default(uuid())
  cartId String
  cart   Cart   @relation(fields: [cartId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id])

  quantity Int @default(1)

  // Fechas espec√≠ficas del item (puede diferir del carrito)
  startDate DateTime?
  endDate   DateTime?

  // Precio guardado en el momento de agregar
  pricePerDay      Decimal @db.Decimal(10, 2)
  shippingCost     Decimal @default(0) @db.Decimal(10, 2)
  installationCost Decimal @default(0) @db.Decimal(10, 2)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([cartId])
  @@index([productId])
}

// Relaci√≥n en Product
// Agregar a Product: cartItems CartItem[]

// ============= CATEGOR√çAS DE EXTRAS PARA CALCULADORA =============

model ExtraCategory {
  id          String  @id @default(uuid())
  name        String  @unique // Ej: "Disco", "FX", "Decoraci√≥n"
  slug        String  @unique
  icon        String  @default("üì¶") // Emoji o c√≥digo de icono
  color       String  @default("purple") // Color tem√°tico para la pesta√±a
  description String?
  order       Int     @default(0) // Orden de visualizaci√≥n
  isActive    Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  products Product[] @relation("ExtraCategoryProducts")

  @@index([isActive, order])
  @@map("extra_categories")
}

// ============= CONTABILIDAD =============

model OperationalExpense {
  id        String   @id @default(uuid())
  concept   String
  amount    Decimal  @db.Decimal(10, 2)
  category  String   // Transporte, Personal, Mantenimiento, Marketing, Oficina, Servicios, Varios
  date      DateTime
  notes     String?  @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@index([date])
  @@map("operational_expenses")
}

// ============= MENSAJES DE CONTACTO =============

enum ContactStatus {
  NEW         // Nuevo - No le√≠do
  READ        // Le√≠do - Visto por admin
  RESPONDED   // Respondido - Se ha contactado al cliente
  ARCHIVED    // Archivado - Resuelto o no relevante
}

enum ContactSource {
  WEBSITE     // Formulario web
  EMAIL       // Email directo
  PHONE       // Llamada telef√≥nica
  WHATSAPP    // WhatsApp
  OTHER       // Otro canal
}

model ContactMessage {
  id        String        @id @default(uuid())
  name      String
  email     String
  phone     String?
  subject   String
  message   String        @db.Text
  status    ContactStatus @default(NEW)
  source    ContactSource @default(WEBSITE)
  
  // Metadata adicional
  metadata     Json?          // IP, userAgent, referrer, etc
  notes        String?        @db.Text // Notas internas del admin
  respondedAt  DateTime?      // Cu√°ndo se respondi√≥
  respondedBy  String?        // ID del admin que respondi√≥
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([status])
  @@index([email])
  @@index([createdAt])
  @@map("contact_messages")
}

// ============= PRESUPUESTOS PROFESIONALES =============

enum BudgetStatus {
  DRAFT       // Borrador - En edici√≥n
  SENT        // Enviado al cliente
  ACCEPTED    // Aceptado por cliente
  REJECTED    // Rechazado
  EXPIRED     // Caducado
  CONVERTED   // Convertido a pedido
}

model Budget {
  id          String       @id @default(uuid())
  
  // Informaci√≥n b√°sica
  budgetNumber String      @unique // BUD-2025-001
  title        String      // "Boda Maria - 15 Junio"
  description  String?     @db.Text
  
  // Cliente
  clientName   String
  clientEmail  String
  clientPhone  String?
  
  // Evento
  eventType    String?     // Boda, Concierto, etc
  eventDate    DateTime?
  eventLocation String?    @db.Text
  attendees    Int?
  
  // Secciones del presupuesto
  sections     BudgetSection[]
  
  // Totales
  subtotal     Decimal     @default(0) @db.Decimal(10, 2)
  discount     Decimal     @default(0) @db.Decimal(10, 2)
  tax          Decimal     @default(0) @db.Decimal(10, 2)
  total        Decimal     @default(0) @db.Decimal(10, 2)
  
  // Estado y validez
  status       BudgetStatus @default(DRAFT)
  validUntil   DateTime?    // Fecha de caducidad
  
  // Notas
  notes        String?      @db.Text // Notas internas
  termsAndConditions String? @db.Text // Condiciones del presupuesto
  
  // Relaci√≥n con pedido (si se convierte)
  orderId      String?      @unique
  order        Order?       @relation(fields: [orderId], references: [id])
  
  // Usuario que lo cre√≥
  createdBy    String
  createdByUser User        @relation(fields: [createdBy], references: [id])
  
  // Timestamps
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  sentAt       DateTime?    // Cu√°ndo se envi√≥ al cliente
  
  @@index([budgetNumber])
  @@index([clientEmail])
  @@index([status])
  @@index([createdBy])
  @@index([createdAt])
  @@map("budgets")
}

model BudgetSection {
  id          String  @id @default(uuid())
  budgetId    String
  budget      Budget  @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  
  // Informaci√≥n de la secci√≥n
  name        String  // "Sonorizaci√≥n", "Iluminaci√≥n", "Montaje"
  description String? @db.Text // Descripci√≥n que ver√° el cliente
  order       Int     @default(0) // Orden de visualizaci√≥n
  
  // Items detallados (internos, no se muestran al cliente)
  items       BudgetItem[]
  
  // Total de la secci√≥n
  subtotal    Decimal @default(0) @db.Decimal(10, 2)
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([budgetId])
  @@map("budget_sections")
}

model BudgetItem {
  id          String        @id @default(uuid())
  sectionId   String
  section     BudgetSection @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  
  // Producto o servicio
  productId   String?       // Referencia a producto (opcional)
  product     Product?      @relation(fields: [productId], references: [id])
  
  // Informaci√≥n del item
  name        String        // Nombre del producto/servicio
  description String?       @db.Text
  quantity    Int           @default(1)
  unitPrice   Decimal       @db.Decimal(10, 2)
  total       Decimal       @db.Decimal(10, 2)
  
  // Metadata
  isInternal  Boolean       @default(true) // Si es true, no se muestra al cliente
  
  // Timestamps
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  
  @@index([sectionId])
  @@index([productId])
  @@map("budget_items")
}

// ============= SEO PAGES =============

model SeoPage {
  id          String   @id @default(uuid())
  
  // URL y metadata
  slug        String   @unique // "alquiler-altavoces-valencia"
  title       String   // "Alquiler de Altavoces en Valencia | ReSona"
  description String   @db.Text // Meta description
  keywords    String[] // ["alquiler altavoces valencia", "alquiler sonido valencia"]
  
  // Sitemap settings
  priority    Float    @default(0.9) // 0.0 - 1.0
  changefreq  String   @default("weekly") // always, hourly, daily, weekly, monthly, yearly, never
  
  // Content (opcional - para p√°ginas generadas din√°micamente en el futuro)
  content     String?  @db.Text
  
  // Estado
  isActive    Boolean  @default(true)
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([slug])
  @@index([isActive])
  @@map("seo_pages")
}

// ============= SISTEMA DE COMISIONES Y LEADS (COMERCIALES) =============

model Commission {
  id              String   @id @default(uuid())
  
  // Comercial que genera la comisi√≥n
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Presupuesto relacionado
  quoteRequestId  String
  quoteRequest    QuoteRequest @relation(fields: [quoteRequestId], references: [id], onDelete: Cascade)
  
  // Montos
  quoteValue      Decimal  @db.Decimal(10, 2) // Valor del presupuesto
  commissionValue Decimal  @db.Decimal(10, 2) // 10% del valor
  commissionRate  Decimal  @default(10) @db.Decimal(5, 2) // Porcentaje de comisi√≥n (10%)
  
  // Estado
  status          CommissionStatus @default(PENDING)
  
  // Pago de la comisi√≥n
  paidAt          DateTime?
  paidBy          String? // ID del admin que pag√≥
  paymentMethod   String? // "transfer", "cash", etc
  paymentNotes    String? @db.Text
  
  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([userId])
  @@index([quoteRequestId])
  @@index([status])
  @@index([createdAt])
  @@map("commissions")
}

model Lead {
  id          String     @id @default(uuid())
  
  // Comercial responsable
  userId      String
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Informaci√≥n del lead
  name        String
  email       String
  phone       String?
  company     String?
  
  // Origen del lead
  origin      String?    @default("web") // web, referido, llamada, evento, etc
  
  // Intereses
  eventType   String?    // Boda, Concierto, Corporativo, etc
  estimatedBudget Decimal? @db.Decimal(10, 2)
  eventDate   DateTime?
  
  // Estado
  status      LeadStatus @default(NEW)
  
  // Notas y seguimiento
  notes       String?    @db.Text
  lastContactDate DateTime?
  nextFollowUpDate DateTime? // Pr√≥ximo seguimiento programado
  
  // Conversi√≥n
  convertedAt DateTime? // Fecha de conversi√≥n a cliente
  convertedToQuoteId String? // ID del presupuesto generado
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([userId])
  @@index([status])
  @@index([email])
  @@index([createdAt])
  @@index([nextFollowUpDate])
  @@map("leads")
}
